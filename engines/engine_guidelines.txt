# Guide: Creating and Using Rails Engines for Modular Development

This guide provides a comprehensive walkthrough for creating, developing, and integrating a Rails engine as a local gem within a larger Rails application. This approach promotes modular design, code reuse, and a clear path to extracting the engine into a standalone gem.

## The "Why": Benefits of Using Engines

Using Rails engines is an excellent way to modularize your application. It allows you to:

- **Isolate Functionality:** Keep feature-specific code (models, controllers, views) separate from the main application.
- **Promote Reusability:** Design components that can be easily shared across different projects.
- **Improve Maintainability:** Work on a smaller, focused codebase, making it easier to understand, test, and refactor.

---

## Step 1: Creating the Engine

This step generates the basic file structure for your engine.

1.  **Create the `engines` directory:**
    It's a good practice to house your local engines in a dedicated `engines` directory at the root of your Rails application.

    ```bash
    mkdir -p engines
    ```

2.  **Generate the engine:**
    Use the `rails plugin new` command to create your engine. The `--mountable` option creates a namespaced engine that is isolated from the main application. The `--dummy-path` option specifies the location of a dummy Rails application for testing your engine in isolation.

    Let's create an engine named `naga_whatsapp`:

    ```bash
    rails plugin new engines/naga_whatsapp --mountable --dummy-path=spec/dummy
    ```

---

## Step 2: Configuring the Engine

Now, let's explore and configure the key files in your newly created engine.

1.  **The `gemspec` file (`engines/naga_whatsapp/naga_whatsapp.gemspec`):**
    This file defines your gem's properties and dependencies. It's like the `Gemfile` for your engine.

    - **`s.name`**: The name of your gem.
    - **`s.version`**: The version of your gem. Follow semantic versioning (e.g., `0.1.0`).
    - **`s.authors`**, **`s.email`**, **`s.homepage`**, **`s.summary`**, **`s.description`**: Fill these in with your gem's information.
    - **`s.license`**: Specify a license (e.g., "MIT").
    - **`s.add_dependency`**: Add any external gems your engine depends on (e.g., `s.add_dependency "http-client"`).

2.  **The main engine file (`engines/naga_whatsapp/lib/naga_whatsapp.rb`):**
    This is the entry point for your engine. It's where you can add `require` statements for other files your engine needs and define a configuration object to allow the parent application to configure the engine.

    Example of a configuration object:
    ```ruby
    module NagaWhatsapp
      mattr_accessor :api_key, :api_secret

      def self.configure
        yield self
      end
    end
    ```

3.  **The Engine class (`engines/naga_whatsapp/lib/naga_whatsapp/engine.rb`):**
    This file makes your engine a Rails engine. It's where you can hook into the Rails initialization process. The `isolate_namespace` call is crucial for keeping your engine's routes, models, and controllers separate from the parent application.

    ```ruby
    module NagaWhatsapp
      class Engine < ::Rails::Engine
        isolate_namespace NagaWhatsapp

        # Example of adding an initializer
        # initializer "naga_whatsapp.assets.precompile" do |app|
        #   app.config.assets.precompile += %w( naga_whatsapp/application.css )
        # end
      end
    end
    ```
4. **The routes file (`config/routes.rb`):** This is where to include the new routes for the engine to be included as part of the parent application
    ```ruby
    Rails.application.routes.draw do
      ...
      mount NagaWhatsapp::Engine, at: "/naga_whatsapp"
      ...
    end
    ```
---

## Step 3: Adding Functionality

Now you can start adding your own models, controllers, views, and services to the engine.

- **`app/models/naga_whatsapp/`**: Place your engine's models here. Use the engine's namespace (e.g., `NagaWhatsapp::Message`).
- **`app/controllers/naga_whatsapp/`**: Place your engine's controllers here (e.g., `NagaWhatsapp::MessagesController`).
- **`app/views/naga_whatsapp/`**: Place your engine's views here.
- **`app/services/naga_whatsapp/`**: A good place for your engine's business logic.

---

## Step 4: Testing the Engine

Your engine has a dummy Rails application in `spec/dummy` that you can use for testing.

1.  **Navigate to the engine's directory:**
    ```bash
    cd engines/naga_whatsapp
    ```

2.  **Install dependencies:**
    ```bash
    bundle install
    ```

3.  **Run migrations for the dummy app:**
    ```bash
    rails db:migrate
    ```

4.  **Run your tests:**
    ```bash
    rspec
    ```
    or
    ```bash
    rails test
    ```

---

## Step 5: Using the Engine in the Parent App

To use your local engine in your main Rails application, you need to reference it in the parent application's `Gemfile`.

1.  **Add the engine to the `Gemfile`:**
    Use the `path:` option to point to your local engine.

    ```ruby
    # Gemfile
    gem "naga_whatsapp", path: "engines/naga_whatsapp"
    ```

2.  **Install the gem:**
    ```bash
    bundle install
    ```

3.  **Create an initializer (optional but recommended):**
    If your engine has configurable attributes, create an initializer in the parent application to set them.

    ```ruby
    # config/initializers/naga_whatsapp.rb
    NagaWhatsapp.configure do |config|
      config.api_key = ENV["WHATSAPP_API_KEY"]
      config.api_secret = ENV["WHATSAPP_API_SECRET"]
    end
    ```

---

## Step 6: Graduating the Engine to a Standalone Gem

Once your engine is mature and stable, you can "graduate" it to a standalone gem.

1.  **Move the engine to its own Git repository:**
    Move the `engines/naga_whatsapp` directory to a new location and initialize a Git repository.

2.  **Push the gem to a Git hosting service (like GitHub):**
    ```bash
    git remote add origin git@github.com:your_username/naga_whatsapp.git
    git push -u origin main
    ```

3.  **Update the parent application's `Gemfile`:**
    Change the `path:` option to the `git:` option.

    ```ruby
    # Gemfile
    gem "naga_whatsapp", git: "git@github.com:your_username/naga_whatsapp.git"
    ```

4.  **Publish to a gem repository (optional):**
    For wider distribution, you can publish your gem to a gem repository like RubyGems.org. This involves updating the `gemspec` with the correct homepage and then running `bundle exec rake release`.

---
This guide should provide a solid foundation for building and using Rails engines. Remember to consult the official [Rails Engines Guide](https://guides.rubyonrails.org/engines.html) for more in-depth information.